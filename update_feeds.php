<?php
include 'db.php';$a=$conn->query("SELECT id,url FROM feeds");$b=$a->fetchAll(PDO::FETCH_ASSOC);foreach($b as $c){$d=$c['id'];$e=$c['url'];libxml_use_internal_errors(true);$f=simplexml_load_file($e);if($f===false){echo "Error al cargar el feed: $e<br>";libxml_clear_errors();continue;}foreach($f->channel->item as $g){$h=(string)$g->title;$i=(string)$g->link;$j=(string)$g->description;$k=implode(', ',(array)$g->category);$l=date('Y-m-d H:i:s',strtotime((string)$g->pubDate));try{$m=$conn->prepare("SELECT id FROM news WHERE title=:h AND url=:i");$m->bindParam(':h',$h);$m->bindParam(':i',$i);$m->execute();if($m->rowCount()==0){$n=$conn->prepare("INSERT INTO news (feed_id,title,url,description,categories,pub_date) VALUES (:d,:h,:i,:j,:k,:l)");$n->bindParam(':d',$d);$n->bindParam(':h',$h);$n->bindParam(':i',$i);$n->bindParam(':j',$j);$n->bindParam(':k',$k);$n->bindParam(':l',$l);$n->execute();}}catch(PDOException $o){echo "Error al guardar la noticia: ".$o->getMessage()."<br>";}}}header('Location: index.php');
?>